{
  "project": "codetether-agent",
  "feature": "Single Runtime Source of Truth with AgentBus",
  "branch_name": "feature/single-runtime-source-of-truth",
  "version": "1.0",
  "user_stories": [
    {
      "id": "US-001",
      "title": "Fix handle_list_tools to iterate metadata HashMap",
      "description": "Modify handle_list_tools() in src/mcp/server.rs:650 to iterate over self.metadata HashMap instead of returning a hardcoded Vec of tools, enabling dynamic tool registration.",
      "acceptance_criteria": [
        "handle_list_tools() iterates self.metadata HashMap",
        "Tools registered via metadata are returned in tools/list response",
        "Function signature remains compatible with MCP protocol"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [],
      "complexity": 2
    },
    {
      "id": "US-002",
      "title": "Verify dynamic tool registration returns registered tool",
      "description": "Register a tool dynamically at runtime and verify tools/list endpoint returns it along with existing tools.",
      "acceptance_criteria": [
        "Register a new tool via metadata insertion",
        "GET /tools/list returns the newly registered tool",
        "Existing hardcoded tools still appear"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-001"
      ],
      "complexity": 2
    },
    {
      "id": "US-003",
      "title": "Add tonic-web gRPC-Web support to Rust server",
      "description": "Add tonic-web 0.14 dependency, enable gRPC-Web on tonic server in src/server/mod.rs with accept_http1 and CORS configuration.",
      "acceptance_criteria": [
        "tonic-web 0.14 added to Cargo.toml",
        "gRPC-Web enabled on tonic server",
        "CORS configured for browser access",
        "Server accepts both HTTP/1.1 and HTTP/2"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [],
      "complexity": 3
    },
    {
      "id": "US-004",
      "title": "Switch proto generation to Connect-ES",
      "description": "Update buf.gen.yaml to use protoc-gen-connect-es and protoc-gen-es instead of existing generators for TypeScript client generation.",
      "acceptance_criteria": [
        "buf.gen.yaml configured for connect-es and es generators",
        "Proto files generate Connect-ES compatible TypeScript",
        "Generated code includes service clients"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [],
      "complexity": 2
    },
    {
      "id": "US-005",
      "title": "Add Connect client dependencies to marketing-site",
      "description": "Add @connectrpc/connect, @connectrpc/connect-web, and @bufbuild/protobuf packages to marketing-site and generate client into marketing-site/src/lib/grpc/.",
      "acceptance_criteria": [
        "npm packages installed in marketing-site",
        "Client code generated to marketing-site/src/lib/grpc/",
        "Types and service clients importable"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-004"
      ],
      "complexity": 2
    },
    {
      "id": "US-006",
      "title": "Replace dashboard REST calls with gRPC-Web",
      "description": "Replace dashboard REST API calls for sendMessage, getTask, cancelTask, and taskSubscription with Connect-ES gRPC-Web calls. Keep REST for codebase and worker CRUD operations.",
      "acceptance_criteria": [
        "sendMessage uses gRPC-Web client",
        "getTask uses gRPC-Web client",
        "cancelTask uses gRPC-Web client",
        "taskSubscription streams via gRPC-Web",
        "Browser network tab shows application/grpc-web content-type"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-003",
        "US-005"
      ],
      "complexity": 4
    },
    {
      "id": "US-007",
      "title": "Add POST /v1/bus/token endpoint for JWT minting",
      "description": "Add POST /v1/bus/token endpoint that mints 5-minute agent-scoped JWTs with topic claims, OPA-authorized via policies/bus.rego.",
      "acceptance_criteria": [
        "POST /v1/bus/token returns JWT with 5-minute expiry",
        "JWT contains agent-scoped topic claims",
        "OPA policy validates token requests",
        "CODETETHER_BUS_JWT_SECRET used for signing"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [],
      "complexity": 3
    },
    {
      "id": "US-008",
      "title": "Add GET /v1/bus/stream SSE endpoint",
      "description": "Add GET /v1/bus/stream SSE endpoint filtered by JWT topic claims for real-time bus event streaming.",
      "acceptance_criteria": [
        "GET /v1/bus/stream accepts JWT for authentication",
        "Events stream via Server-Sent Events",
        "Events filtered by JWT topic claims",
        "Connection survives JWT expiry with remint"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-007"
      ],
      "complexity": 3
    },
    {
      "id": "US-009",
      "title": "Add POST /v1/bus/publish endpoint",
      "description": "Add POST /v1/bus/publish endpoint validated by JWT for publishing events to the bus.",
      "acceptance_criteria": [
        "POST /v1/bus/publish validates JWT",
        "Publish request includes topic and payload",
        "Invalid JWT returns 401",
        "Event published to subscribers"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-007"
      ],
      "complexity": 2
    },
    {
      "id": "US-010",
      "title": "Dashboard EventSource subscribes with auto-remint",
      "description": "Update dashboard to subscribe to bus via EventSource with automatic JWT reminting on expiry, replacing per-codebase EventSource.",
      "acceptance_criteria": [
        "Dashboard uses single EventSource connection",
        "JWT automatically reminted before expiry",
        "Events processed and displayed in UI",
        "No duplicate or missed events during remint"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-008"
      ],
      "complexity": 3
    },
    {
      "id": "US-011",
      "title": "Create Python bus_client.py SSE client",
      "description": "Create a2a_server/bus_client.py with SSE client that connects to GET /v1/bus/stream and publishes ToolRequest and ToolResponse events.",
      "acceptance_criteria": [
        "bus_client.py connects to /v1/bus/stream",
        "Handles JWT refresh automatically",
        "Publishes ToolRequest events on tool calls",
        "Publishes ToolResponse events on tool results"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-008",
        "US-009"
      ],
      "complexity": 3
    },
    {
      "id": "US-012",
      "title": "Verify Python tool calls visible on bus",
      "description": "Verify that Python tool calls are visible on the bus by triggering an agent in one browser tab and observing bus events in another.",
      "acceptance_criteria": [
        "Agent triggered in browser tab",
        "ToolRequest event appears in dashboard subscription",
        "ToolResponse event appears after tool execution",
        "Events contain correct tool name and parameters"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-010",
        "US-011"
      ],
      "complexity": 2
    },
    {
      "id": "US-013",
      "title": "Add GET /v1/tools unified endpoint",
      "description": "Add GET /v1/tools endpoint returning merged Rust MCP tools plus remote registrations tagged by source.",
      "acceptance_criteria": [
        "GET /v1/tools returns all registered tools",
        "Each tool includes source tag (rust/python)",
        "Remote Python tools included",
        "Response includes tool metadata (name, description, params)"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-001",
        "US-002"
      ],
      "complexity": 2
    },
    {
      "id": "US-014",
      "title": "Add POST /v1/tools/register with heartbeat and TTL",
      "description": "Add POST /v1/tools/register endpoint with 30-second heartbeat, 90-second TTL, and 15-second reaper for tool registration management.",
      "acceptance_criteria": [
        "POST /v1/tools/register accepts tool metadata",
        "30-second heartbeat keeps registration alive",
        "90-second TTL expires unused tools",
        "15-second reaper removes expired tools",
        "DELETE /v1/tools/register removes registration"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-013"
      ],
      "complexity": 4
    },
    {
      "id": "US-015",
      "title": "Python registers tools on startup and deletes on shutdown",
      "description": "Update Python server to register tools on startup via POST /v1/tools/register and delete on shutdown via DELETE.",
      "acceptance_criteria": [
        "Python calls POST /v1/tools/register on startup",
        "Python sends heartbeat every 30 seconds",
        "Python calls DELETE on shutdown",
        "Tools appear in GET /v1/tools within startup"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-014"
      ],
      "complexity": 3
    },
    {
      "id": "US-016",
      "title": "Bus emits registration and expiry events",
      "description": "Emit bus events on tool registration and expiry so subscribers can react to tool availability changes.",
      "acceptance_criteria": [
        "Bus event emitted on tool registration",
        "Bus event emitted on tool expiry",
        "Event contains tool name and source",
        "Dashboard receives and processes events"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-014",
        "US-010"
      ],
      "complexity": 2
    },
    {
      "id": "US-017",
      "title": "Build Dashboard ToolExplorer component",
      "description": "Build Dashboard ToolExplorer component grouped by source with name, description, parameters, and try-it button.",
      "acceptance_criteria": [
        "ToolExplorer displays tools grouped by source",
        "Shows tool name, description, and parameters",
        "Try-it button allows parameter input and execution",
        "Rust tools (35+) and Python tools (4+) displayed",
        "Tools disappear within 90s when Python killed"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-013",
        "US-015",
        "US-016"
      ],
      "complexity": 3
    },
    {
      "id": "US-018",
      "title": "Verify unified tool explorer shows 35+ Rust and 4+ Python tools",
      "description": "Verify the ToolExplorer component displays at least 35 Rust tools and 4 Python tools, with Python tools disappearing within 90 seconds of Python process termination.",
      "acceptance_criteria": [
        "ToolExplorer shows 35+ Rust tools",
        "ToolExplorer shows 4+ Python tools",
        "Kill Python process",
        "Python tools disappear within 90 seconds"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-017"
      ],
      "complexity": 2
    },
    {
      "id": "US-019",
      "title": "Verify relay completes all rounds with live state sharing",
      "description": "End-to-end verification that relay completes all communication rounds with live state shared between Rust, Python, and React dashboard via AgentBus.",
      "acceptance_criteria": [
        "Rust MCP server handles tool calls",
        "Python publishes tool events to bus",
        "Dashboard receives real-time updates",
        "All rounds complete without failure",
        "100% relay completion rate"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-012",
        "US-018"
      ],
      "complexity": 4
    },
    {
      "id": "US-020",
      "title": "Ensure no critical errors in production",
      "description": "Verify the system operates without critical errors across all phases, with zero critical error count in logs.",
      "acceptance_criteria": [
        "No panics in Rust server",
        "No unhandled exceptions in Python",
        "No console errors in browser",
        "System stable under normal load",
        "All endpoints return appropriate status codes"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-019"
      ],
      "complexity": 3
    }
  ],
  "technical_requirements": [
    "Rust server must expose gRPC-Web via tonic-web 0.14",
    "Connect-ES used for TypeScript client generation",
    "JWT tokens signed with CODETETHER_BUS_JWT_SECRET",
    "OPA policy for bus endpoint authorization",
    "SSE for real-time bus streaming",
    "30-second heartbeat, 90-second TTL, 15-second reaper for tool registration",
    "EventSource with auto-remint for dashboard bus subscription",
    "Python bus_client.py for SSE connection and publishing",
    "Unified /v1/tools endpoint merges local and remote tools",
    "Dashboard ToolExplorer grouped by source"
  ],
  "quality_checks": {
    "typecheck": "cargo check",
    "test": "cargo test",
    "lint": "cargo clippy --all-features",
    "build": "cargo build"
  },
  "created_at": "2026-02-14T21:28:00.380190119+00:00",
  "updated_at": "2026-02-14T21:28:00.380190119+00:00"
}