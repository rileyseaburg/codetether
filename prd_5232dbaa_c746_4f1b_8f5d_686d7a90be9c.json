{
  "project": "codetether-agent",
  "feature": "Unified AgentBus Runtime State",
  "branch_name": "feature/unified-agentbus-runtime",
  "version": "1.0",
  "user_stories": [
    {
      "id": "US-001",
      "title": "Fix handle_list_tools to use dynamic HashMap metadata",
      "description": "Modify src/mcp/server.rs:650 handle_list_tools() to iterate self.metadata HashMap instead of returning a hardcoded Vec. This enables dynamic tool registration at runtime.",
      "acceptance_criteria": [
        "handle_list_tools() iterates self.metadata HashMap",
        "Registered tools appear in tools/list response",
        "Hardcoded Vec is removed"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [],
      "complexity": 2
    },
    {
      "id": "US-002",
      "title": "Verify dynamic tool registration works end-to-end",
      "description": "Register a tool dynamically at runtime and verify tools/list returns it. Validates Phase 0 completion.",
      "acceptance_criteria": [
        "Tool registered at runtime appears in /tools/list",
        "Response includes tool name, description, and parameters"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-001"
      ],
      "complexity": 2
    },
    {
      "id": "US-003",
      "title": "Add tonic-web 0.14 and enable gRPC-Web on Rust server",
      "description": "Add tonic-web 0.14 dependency to Cargo.toml, enable gRPC-Web on tonic server in src/server/mod.rs with accept_http1 and CORS configuration.",
      "acceptance_criteria": [
        "tonic-web 0.14 in Cargo.toml",
        "gRPC-Web enabled with accept_http1",
        "CORS configured for marketing-site origin"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-002"
      ],
      "complexity": 3
    },
    {
      "id": "US-004",
      "title": "Update buf.gen.yaml for Connect-ES gRPC-Web",
      "description": "Switch buf.gen.yaml from grpc to protoc-gen-connect-es + protoc-gen-es for browser-compatible gRPC-Web.",
      "acceptance_criteria": [
        "buf.gen.yaml uses connect-es generators",
        "Generate command produces browser-compatible code"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-003"
      ],
      "complexity": 2
    },
    {
      "id": "US-005",
      "title": "Add Connect-ES dependencies to marketing-site",
      "description": "Add @connectrpc/connect, @connectrpc/connect-web, @bufbuild/protobuf packages to marketing-site and generate client into marketing-site/src/lib/grpc/.",
      "acceptance_criteria": [
        "Dependencies added to package.json",
        "Client code generated in marketing-site/src/lib/grpc/",
        "TypeScript types available for gRPC calls"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-004"
      ],
      "complexity": 3
    },
    {
      "id": "US-006",
      "title": "Replace dashboard REST calls with gRPC-Web",
      "description": "Replace dashboard REST calls for sendMessage, getTask, cancelTask, taskSubscription with Connect-ES gRPC-Web calls. Keep REST for codebase and worker CRUD.",
      "acceptance_criteria": [
        "sendMessage uses gRPC-Web",
        "getTask uses gRPC-Web",
        "cancelTask uses gRPC-Web",
        "taskSubscription uses gRPC-Web",
        "Codebase CRUD remains REST",
        "Worker CRUD remains REST"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-005"
      ],
      "complexity": 4
    },
    {
      "id": "US-007",
      "title": "Verify browser network tab shows application/grpc-web",
      "description": "Verify gRPC-Web traffic is being sent by checking browser network tab shows application/grpc-web content type.",
      "acceptance_criteria": [
        "Network tab shows Content-Type: application/grpc-web",
        "gRPC-Web frames are visible",
        "No fallback to REST for replaced endpoints"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-006"
      ],
      "complexity": 2
    },
    {
      "id": "US-008",
      "title": "Implement POST /v1/bus/token JWT minting endpoint",
      "description": "Add POST /v1/bus/token endpoint that mints 5-minute agent-scoped JWTs, OPA-authorized via policies/bus.rego. Signing key from CODETETHER_BUS_JWT_SECRET env var.",
      "acceptance_criteria": [
        "Endpoint returns JWT with 5-minute expiry",
        "JWT contains agent-scoped claims",
        "OPA policy validates authorization",
        "Uses CODETETHER_BUS_JWT_SECRET for signing"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-007"
      ],
      "complexity": 4
    },
    {
      "id": "US-009",
      "title": "Implement GET /v1/bus/stream SSE endpoint",
      "description": "Add GET /v1/bus/stream SSE endpoint filtered by JWT topic claims for real-time bus events.",
      "acceptance_criteria": [
        "SSE connection established",
        "Events filtered by JWT topic claims",
        "Connection persists until closed"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-008"
      ],
      "complexity": 3
    },
    {
      "id": "US-010",
      "title": "Implement POST /v1/bus/publish endpoint",
      "description": "Add POST /v1/bus/publish endpoint validated by JWT for publishing events to the bus.",
      "acceptance_criteria": [
        "Endpoint accepts event payload",
        "JWT validation required",
        "Event published to bus"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-008"
      ],
      "complexity": 3
    },
    {
      "id": "US-011",
      "title": "Implement dashboard EventSource with auto-remint",
      "description": "Dashboard subscribes via EventSource with auto-remint on expiry, replacing current per-codebase EventSource.",
      "acceptance_criteria": [
        "Dashboard connects to /v1/bus/stream",
        "JWT auto-remints on expiry",
        "No manual reconnection required"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-009",
        "US-010"
      ],
      "complexity": 3
    },
    {
      "id": "US-012",
      "title": "Implement Python bus_client.py SSE client",
      "description": "Create a2a_server/bus_client.py SSE client that connects to bus stream and publishes ToolRequest and ToolResponse events.",
      "acceptance_criteria": [
        "Python connects to /v1/bus/stream",
        "Publishes ToolRequest events",
        "Publishes ToolResponse events",
        "Visible on bus from other components"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-009",
        "US-010"
      ],
      "complexity": 3
    },
    {
      "id": "US-013",
      "title": "Verify cross-tab bus events propagation",
      "description": "Verify triggering agent in one tab causes bus events to arrive in another tab. Kill Python, bus continues.",
      "acceptance_criteria": [
        "Events from tab A appear in tab B",
        "Python disconnected does not break bus",
        "Bus continues functioning"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-011",
        "US-012"
      ],
      "complexity": 3
    },
    {
      "id": "US-014",
      "title": "Implement GET /v1/tools merged tool listing",
      "description": "Add GET /v1/tools endpoint returning merged Rust MCP tools plus remote registrations tagged by source.",
      "acceptance_criteria": [
        "Returns all Rust MCP tools",
        "Returns remote registrations with source tag",
        "Response includes tool metadata"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-013"
      ],
      "complexity": 3
    },
    {
      "id": "US-015",
      "title": "Implement POST /v1/tools/register with heartbeat and TTL",
      "description": "Add POST /v1/tools/register with 30-second heartbeat, 90-second TTL, and 15-second reaper for tool registration lifecycle.",
      "acceptance_criteria": [
        "Registration accepted with heartbeat",
        "TTL of 90 seconds enforced",
        "Reaper cleans up expired registrations every 15 seconds"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-014"
      ],
      "complexity": 4
    },
    {
      "id": "US-016",
      "title": "Implement Python tool registration lifecycle",
      "description": "Python registers tools on startup with heartbeat and DELETE on shutdown. Bus events emitted on registration and expiry.",
      "acceptance_criteria": [
        "Python registers on startup",
        "Sends heartbeat every 30 seconds",
        "Deregisters on shutdown",
        "Bus events for registration and expiry"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-015"
      ],
      "complexity": 3
    },
    {
      "id": "US-017",
      "title": "Build Dashboard ToolExplorer component",
      "description": "Dashboard ToolExplorer component grouped by source with name, description, params, and try-it button.",
      "acceptance_criteria": [
        "Tools grouped by source (Rust/Python)",
        "Displays name, description, parameters",
        "Try-it button functional",
        "35+ Rust tools visible",
        "4+ Python tools visible"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-014",
        "US-015",
        "US-016"
      ],
      "complexity": 4
    },
    {
      "id": "US-018",
      "title": "Verify tool cleanup on Python disconnect",
      "description": "Verify killing Python causes Python tools to disappear from explorer within 90 seconds TTL.",
      "acceptance_criteria": [
        "Python tools visible before disconnect",
        "Python tools removed within 90 seconds",
        "Rust tools unaffected"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-017"
      ],
      "complexity": 3
    },
    {
      "id": "US-019",
      "title": "Verify relay completes all rounds",
      "description": "End-to-end validation that relay communication completes all rounds successfully across all components.",
      "acceptance_criteria": [
        "100% round completion rate",
        "No dropped messages",
        "All components in sync"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-013",
        "US-018"
      ],
      "complexity": 4
    },
    {
      "id": "US-020",
      "title": "Produce actionable handoff artifact",
      "description": "Team produces one actionable handoff document covering architecture, API contracts, and deployment steps.",
      "acceptance_criteria": [
        "Handoff document created",
        "Includes architecture diagram",
        "Documents API contracts",
        "Includes deployment steps"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-019"
      ],
      "complexity": 2
    },
    {
      "id": "US-021",
      "title": "Verify zero critical errors in production",
      "description": "Run full integration tests ensuring no critical errors occur during normal operation.",
      "acceptance_criteria": [
        "0 critical errors logged",
        "No panics in Rust",
        "No exceptions in Python",
        "No React errors"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-019"
      ],
      "complexity": 3
    }
  ],
  "technical_requirements": [
    "Rust server must run tonic-web 0.14 with gRPC-Web enabled",
    "buf.build must generate connect-es compatible protos",
    "marketing-site must use @connectrpc/connect-web for gRPC-Web calls",
    "Bus must support SSE for real-time event streaming",
    "JWT tokens must expire after 5 minutes and support auto-remint",
    "OPA must authorize bus token requests via policies/bus.rego",
    "Tool registrations must have 90-second TTL with 30-second heartbeat",
    "Reaper must run every 15 seconds to clean expired registrations",
    "Python bus_client.py must publish ToolRequest and ToolResponse events",
    "Dashboard must replace per-codebase EventSource with unified bus subscription",
    "CODETETHER_BUS_JWT_SECRET env var required for JWT signing"
  ],
  "quality_checks": {
    "typecheck": "cargo check",
    "test": "cargo test",
    "lint": "cargo clippy --all-features",
    "build": "cargo build"
  },
  "created_at": "2026-02-14T20:10:12.760468533+00:00",
  "updated_at": "2026-02-14T20:10:12.760468533+00:00"
}