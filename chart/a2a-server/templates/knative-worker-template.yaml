{{- if .Values.knative.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "a2a-server.fullname" . }}-knative-worker-template
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "a2a-server.labels" . | nindent 4 }}
data:
  service-template.yaml: |
    apiVersion: serving.knative.dev/v1
    kind: Service
    metadata:
      name: codetether-session-SESSION_ID
      namespace: {{ .Release.Namespace }}
      labels:
        codetether.run/tenant: "TENANT_ID"
        codetether.run/session: "SESSION_ID"
        codetether.run/codebase: "CODEBASE_ID"
    spec:
      template:
        metadata:
          annotations:
            autoscaling.knative.dev/min-scale: "0"
            autoscaling.knative.dev/max-scale: "1"
            autoscaling.knative.dev/scale-to-zero-pod-retention-period: "{{ .Values.knative.worker.idleTimeoutSeconds | default 300 }}s"
        spec:
          containerConcurrency: {{ .Values.knative.worker.containerConcurrency | default 1 }}
          timeoutSeconds: {{ .Values.knative.worker.maxTimeoutSeconds | default 600 }}
          containers:
            - image: {{ .Values.knative.worker.image }}
              env:
                - name: A2A_TENANT_ID
                  value: "TENANT_ID"
                - name: A2A_SESSION_ID
                  value: "SESSION_ID"
                - name: A2A_CODEBASE_ID
                  value: "CODEBASE_ID"
                # codetether stores state in its own format
                - name: CODETETHER_LOG_LEVEL
                  value: "info"
                - name: DATABASE_URL
                  value: "{{ .Values.externalPostgresql.url }}"
                - name: MINIO_ENDPOINT
                  value: "{{ .Values.minio.endpoint }}"
                - name: MINIO_BUCKET
                  value: "{{ .Values.minio.bucket }}"
                - name: MINIO_ACCESS_KEY
                  value: "{{ .Values.minio.accessKey }}"
                - name: MINIO_SECRET_KEY
                  value: "{{ .Values.minio.secretKey }}"
                - name: MINIO_SECURE
                  value: "{{ .Values.minio.secure }}"
                # A2A Server callback URL for task status updates
                - name: A2A_SERVER_URL
                  value: "http://{{ include "a2a-server.fullname" . }}:{{ .Values.service.port }}"
                {{- if .Values.knative.worker.apiKeySecret }}
                # AI provider API keys from secret
                - name: ANTHROPIC_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.knative.worker.apiKeySecret }}
                      key: ANTHROPIC_API_KEY
                      optional: true
                - name: OPENAI_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.knative.worker.apiKeySecret }}
                      key: OPENAI_API_KEY
                      optional: true
                - name: GOOGLE_GENERATIVE_AI_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.knative.worker.apiKeySecret }}
                      key: GOOGLE_GENERATIVE_AI_API_KEY
                      optional: true
                {{- end }}
                {{- if .Values.knative.worker.gcpCredentialsSecret }}
                # GCP credentials for Vertex AI
                - name: GOOGLE_APPLICATION_CREDENTIALS
                  value: "/secrets/gcp/credentials.json"
                - name: GOOGLE_VERTEX_LOCATION
                  value: "{{ .Values.knative.worker.googleVertexLocation | default "us-central1" }}"
                - name: GOOGLE_VERTEX_PROJECT
                  value: "{{ .Values.knative.worker.googleVertexProject | default "spotlessbinco" }}"
                {{- end }}
                {{- if .Values.knative.worker.sendgridSecret }}
                # SendGrid email configuration
                - name: SENDGRID_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.knative.worker.sendgridSecret }}
                      key: SENDGRID_API_KEY
                - name: SENDGRID_FROM_EMAIL
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.knative.worker.sendgridSecret }}
                      key: SENDGRID_FROM_EMAIL
                - name: EMAIL_INBOUND_DOMAIN
                  value: "{{ .Values.knative.worker.emailInboundDomain | default "" }}"
                {{- end }}
                {{- if .Values.knative.worker.dbEncryptionSecret }}
                # Database encryption key for API key encryption
                - name: DB_ENCRYPTION_KEY
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.knative.worker.dbEncryptionSecret }}
                      key: encryption-key
                {{- end }}
              {{- if or .Values.knative.worker.authSecret .Values.knative.worker.configSecret .Values.knative.worker.gcpCredentialsSecret .Values.knative.worker.dbEncryptionSecret }}
              volumeMounts:
                {{- if .Values.knative.worker.authSecret }}
                - name: worker-auth
                  mountPath: /secrets/worker-auth
                  readOnly: true
                {{- end }}
                {{- if .Values.knative.worker.configSecret }}
                - name: worker-config
                  mountPath: /secrets/worker-config
                  readOnly: true
                {{- end }}
                {{- if .Values.knative.worker.gcpCredentialsSecret }}
                - name: gcp-credentials
                  mountPath: /secrets/gcp
                  readOnly: true
                {{- end }}
              {{- end }}
              resources:
                limits:
                  memory: {{ .Values.knative.worker.resources.limits.memory | default "2Gi" }}
                  cpu: {{ .Values.knative.worker.resources.limits.cpu | default "2" | quote }}
                requests:
                  memory: {{ .Values.knative.worker.resources.requests.memory | default "512Mi" }}
                  cpu: {{ .Values.knative.worker.resources.requests.cpu | default "250m" | quote }}
          {{- if or .Values.knative.worker.authSecret .Values.knative.worker.configSecret .Values.knative.worker.gcpCredentialsSecret }}
          volumes:
            {{- if .Values.knative.worker.authSecret }}
            - name: worker-auth
              secret:
                secretName: {{ .Values.knative.worker.authSecret }}
            {{- end }}
            {{- if .Values.knative.worker.configSecret }}
            - name: worker-config
              secret:
                secretName: {{ .Values.knative.worker.configSecret }}
            {{- end }}
            {{- if .Values.knative.worker.gcpCredentialsSecret }}
            - name: gcp-credentials
              secret:
                secretName: {{ .Values.knative.worker.gcpCredentialsSecret }}
            {{- end }}
          {{- end }}
  trigger-template.yaml: |
    apiVersion: eventing.knative.dev/v1
    kind: Trigger
    metadata:
      name: trigger-session-SESSION_ID
      namespace: {{ .Release.Namespace }}
      labels:
        codetether.run/tenant: "TENANT_ID"
        codetether.run/session: "SESSION_ID"
    spec:
      broker: {{ .Values.knative.broker | default "task-broker" }}
      filter:
        attributes:
          type: codetether.task.created
          session: "SESSION_ID"
      subscriber:
        ref:
          apiVersion: serving.knative.dev/v1
          kind: Service
          name: codetether-session-SESSION_ID
        uri: /task
{{- end }}
