{
  "project": "codetether-agent",
  "feature": "Single Runtime Source of Truth with AgentBus",
  "branch_name": "feature/single-runtime-source-of-truth",
  "version": "1.0",
  "user_stories": [
    {
      "id": "US-001",
      "title": "Fix handle_list_tools to use dynamic HashMap iteration",
      "description": "Update handle_list_tools() in src/mcp/server.rs:650 to iterate self.metadata HashMap instead of returning a hardcoded Vec. This enables dynamic tool registration at runtime.",
      "acceptance_criteria": [
        "handle_list_tools() iterates self.metadata HashMap",
        "Tools registered dynamically appear in tools/list response",
        "Code compiles without errors"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [],
      "complexity": 2
    },
    {
      "id": "US-002",
      "title": "Verify dynamic tool registration works",
      "description": "Register a tool dynamically and verify tools/list returns it. Test the dynamic tool listing functionality end-to-end.",
      "acceptance_criteria": [
        "Register a new tool at runtime",
        "Call tools/list endpoint",
        "Registered tool appears in response"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-001"
      ],
      "complexity": 2
    },
    {
      "id": "US-003",
      "title": "Add tonic-web gRPC-Web support to Rust server",
      "description": "Add tonic-web 0.14 dependency, enable gRPC-Web on the tonic server in src/server/mod.rs with accept_http1 and CORS configuration.",
      "acceptance_criteria": [
        "tonic-web crate added to Cargo.toml",
        "gRPC-Web endpoint enabled with CORS",
        "Server accepts gRPC-Web requests"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-002"
      ],
      "complexity": 3
    },
    {
      "id": "US-004",
      "title": "Switch protoc plugins to Connect-ES",
      "description": "Update buf.gen.yaml to use protoc-gen-connect-es and protoc-gen-es instead of current plugins. Generate updated client stubs.",
      "acceptance_criteria": [
        "buf.gen.yaml uses connect-es plugins",
        "Client stubs generated successfully",
        "Code compiles with generated code"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-003"
      ],
      "complexity": 2
    },
    {
      "id": "US-005",
      "title": "Add Connect-ES packages to marketing-site",
      "description": "Add @connectrpc/connect, @connectrpc/connect-web, and @bufbuild/protobuf dependencies to the marketing-site frontend.",
      "acceptance_criteria": [
        "npm packages installed successfully",
        "Imports work in TypeScript",
        "No build errors"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-004"
      ],
      "complexity": 2
    },
    {
      "id": "US-006",
      "title": "Generate gRPC client into marketing-site",
      "description": "Generate gRPC client into marketing-site/src/lib/grpc/ using updated buf configuration.",
      "acceptance_criteria": [
        "Client files generated in correct directory",
        "TypeScript types available",
        "No compilation errors"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-005"
      ],
      "complexity": 2
    },
    {
      "id": "US-007",
      "title": "Replace dashboard REST calls with gRPC-Web",
      "description": "Replace dashboard REST calls for sendMessage, getTask, cancelTask, and taskSubscription with Connect-ES gRPC-Web calls. Keep REST for codebase and worker CRUD.",
      "acceptance_criteria": [
        "sendMessage uses gRPC-Web",
        "getTask uses gRPC-Web",
        "cancelTask uses gRPC-Web",
        "taskSubscription uses gRPC-Web",
        "Codebase/worker CRUD still uses REST"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-006"
      ],
      "complexity": 4
    },
    {
      "id": "US-008",
      "title": "Verify gRPC-Web traffic in browser",
      "description": "Verify browser network tab shows application/grpc-web content type for all replaced calls.",
      "acceptance_criteria": [
        "Network tab shows application/grpc-web for task calls",
        "No REST fallback for replaced endpoints",
        "All gRPC-Web calls succeed"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-007"
      ],
      "complexity": 2
    },
    {
      "id": "US-009",
      "title": "Implement bus token endpoint with JWT minting",
      "description": "Add POST /v1/bus/token that mints 5-minute agent-scoped JWTs, OPA-authorized via policies/bus.rego. Use CODETETHER_BUS_JWT_SECRET env var for signing.",
      "acceptance_criteria": [
        "POST /v1/bus/token returns valid JWT",
        "JWT expires in 5 minutes",
        "OPA policy validates token requests",
        "Uses correct secret from env var"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-008"
      ],
      "complexity": 4
    },
    {
      "id": "US-010",
      "title": "Implement bus stream SSE endpoint",
      "description": "Add GET /v1/bus/stream SSE endpoint filtered by JWT topic claims.",
      "acceptance_criteria": [
        "GET /v1/bus/stream returns SSE stream",
        "Events filtered by JWT topic claims",
        "Connection stays open for streaming"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-009"
      ],
      "complexity": 3
    },
    {
      "id": "US-011",
      "title": "Implement bus publish endpoint",
      "description": "Add POST /v1/bus/publish validated by JWT. Events are published to the bus.",
      "acceptance_criteria": [
        "POST /v1/bus/publish accepts event payload",
        "JWT validation required",
        "Events broadcast to subscribers"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-010"
      ],
      "complexity": 3
    },
    {
      "id": "US-012",
      "title": "Update dashboard to use EventSource with auto-remint",
      "description": "Dashboard subscribes via EventSource with auto-remint on expiry, replacing current per-codebase EventSource.",
      "acceptance_criteria": [
        "Dashboard uses single EventSource",
        "Token auto-remints on expiry",
        "No manual reconnection needed"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-011"
      ],
      "complexity": 3
    },
    {
      "id": "US-013",
      "title": "Create Python bus_client.py SSE client",
      "description": "Create a2a_server/bus_client.py with SSE client that connects to /v1/bus/stream and publishes ToolRequest and ToolResponse events.",
      "acceptance_criteria": [
        "Python connects to SSE stream",
        "Publishes ToolRequest events",
        "Publishes ToolResponse events",
        "Handles reconnection on expiry"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-012"
      ],
      "complexity": 3
    },
    {
      "id": "US-014",
      "title": "Verify cross-tab bus events work",
      "description": "Verify triggering agent in one tab causes bus events to arrive in another tab.",
      "acceptance_criteria": [
        "Agent trigger in tab A",
        "Events received in tab B",
        "Events visible in real-time"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-013"
      ],
      "complexity": 2
    },
    {
      "id": "US-015",
      "title": "Verify bus continues after Python disconnect",
      "description": "Verify bus continues functioning after Python process is killed.",
      "acceptance_criteria": [
        "Kill Python process",
        "Bus still operational",
        "Rust-side events still work"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-014"
      ],
      "complexity": 2
    },
    {
      "id": "US-016",
      "title": "Implement unified tools endpoint",
      "description": "Add GET /v1/tools returning merged Rust MCP plus remote registrations tagged by source.",
      "acceptance_criteria": [
        "GET /v1/tools returns all tools",
        "Tools tagged by source (Rust/Python)",
        "Includes tool metadata (name, description, params)"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-015"
      ],
      "complexity": 3
    },
    {
      "id": "US-017",
      "title": "Implement tool registration with heartbeat and TTL",
      "description": "Add POST /v1/tools/register with 30-second heartbeat, 90-second TTL, and 15-second reaper cleanup.",
      "acceptance_criteria": [
        "POST /v1/tools/register accepts tool",
        "Heartbeat resets TTL",
        "TTL expires after 90 seconds",
        "Reaper cleans up expired tools"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-016"
      ],
      "complexity": 4
    },
    {
      "id": "US-018",
      "title": "Python registers tools on startup",
      "description": "Python server registers tools on startup via POST /v1/tools/register and deletes on shutdown.",
      "acceptance_criteria": [
        "Python calls register on startup",
        "Python calls delete on shutdown",
        "Registration includes heartbeat"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-017"
      ],
      "complexity": 3
    },
    {
      "id": "US-019",
      "title": "Create dashboard ToolExplorer component",
      "description": "Build ToolExplorer component grouped by source with name, description, params, and try-it button.",
      "acceptance_criteria": [
        "Component displays tools grouped by source",
        "Shows name, description, params",
        "Try-it button functional",
        "Filters by source"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-018"
      ],
      "complexity": 3
    },
    {
      "id": "US-020",
      "title": "Verify 35+ Rust tools and 4+ Python tools visible",
      "description": "Verify ToolExplorer shows 35+ Rust tools and 4+ Python tools.",
      "acceptance_criteria": [
        "ToolExplorer shows 35+ Rust tools",
        "ToolExplorer shows 4+ Python tools",
        "Tools grouped by source"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-019"
      ],
      "complexity": 2
    },
    {
      "id": "US-021",
      "title": "Verify Python tools disappear after Python disconnect",
      "description": "Kill Python process and verify Python tools disappear from ToolExplorer within 90 seconds.",
      "acceptance_criteria": [
        "Kill Python process",
        "Python tools removed within 90 seconds",
        "Rust tools remain"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-020"
      ],
      "complexity": 2
    },
    {
      "id": "US-022",
      "title": "Relay completes all rounds with 100% success",
      "description": "End-to-end test ensuring relay completes all communication rounds between all components (Rust, Python, React dashboard) with 100% success rate.",
      "acceptance_criteria": [
        "All message rounds complete successfully",
        "No dropped messages",
        "All components stay in sync"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-021"
      ],
      "complexity": 5
    },
    {
      "id": "US-023",
      "title": "Produce actionable handoff documentation",
      "description": "Create comprehensive documentation for team handoff covering architecture, APIs, and operational procedures.",
      "acceptance_criteria": [
        "Architecture documentation complete",
        "API reference documented",
        "Operational procedures documented",
        "Team can operate system independently"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-022"
      ],
      "complexity": 3
    },
    {
      "id": "US-024",
      "title": "Zero critical errors in production",
      "description": "Ensure all phases deploy with zero critical errors in production environment.",
      "acceptance_criteria": [
        "No runtime panics",
        "No unhandled exceptions",
        "No data corruption",
        "All health checks pass"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-023"
      ],
      "complexity": 3
    }
  ],
  "technical_requirements": [
    "Rust backend with tonic-web for gRPC-Web support",
    "Connect-ES for TypeScript gRPC-Web client",
    "OPA policy engine for bus authorization",
    "JWT tokens with 5-minute expiry for bus access",
    "SSE streaming for real-time bus updates",
    "EventSource with auto-reconnection for dashboard",
    "Python a2a_server with bus_client.py",
    "Heartbeat/TTL mechanism for tool registration",
    "Reaper process for expired tool cleanup"
  ],
  "quality_checks": {
    "typecheck": "cargo check",
    "test": "cargo test",
    "lint": "cargo clippy --all-features",
    "build": "cargo build --release"
  },
  "created_at": "2026-02-15T00:01:31.520170340+00:00",
  "updated_at": "2026-02-15T00:01:31.520170340+00:00"
}