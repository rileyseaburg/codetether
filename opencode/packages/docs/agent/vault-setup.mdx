---
title: "Vault Setup"
description: "Configure HashiCorp Vault for secure secrets management"
---

## Overview

CodeTether Agent uses HashiCorp Vault for all secrets management. This provides:

- **Security**: No API keys in environment variables or config files
- **Rotation**: Easy secret rotation without restarting agents
- **Auditing**: Full audit trail of secret access
- **Access Control**: Fine-grained policies for who can access what

<Warning>
  **API keys via environment variables are not supported.**
  
  Variables like `OPENAI_API_KEY` or `ANTHROPIC_API_KEY` are ignored. All secrets must be stored in Vault.
</Warning>

## Quick Start (Development)

For development, use Vault's dev server:

```bash
# Start Vault in dev mode
vault server -dev

# In another terminal
export VAULT_ADDR="http://127.0.0.1:8200"
export VAULT_TOKEN="root"

# Store your API keys
vault kv put secret/codetether/providers/openai api_key="sk-..."
vault kv put secret/codetether/providers/anthropic api_key="sk-ant-..."

# Run CodeTether
codetether --server https://api.codetether.run
```

## Secret Structure

Secrets are stored under `secret/codetether/providers/<provider-id>`:

```
secret/codetether/providers/
├── openai
│   ├── api_key: "sk-..."
│   └── organization: "org-..."  (optional)
├── anthropic
│   └── api_key: "sk-ant-..."
├── google
│   └── api_key: "AIza..."
├── deepseek
│   └── api_key: "..."
└── ...
```

### Supported Fields

| Field | Description |
|-------|-------------|
| `api_key` | Provider API key (required) |
| `base_url` | Custom API endpoint (optional) |
| `organization` | Organization ID (optional, OpenAI) |
| `headers` | Custom headers as JSON object (optional) |

### Example: OpenAI with Organization

```bash
vault kv put secret/codetether/providers/openai \
  api_key="sk-..." \
  organization="org-abc123" \
  base_url="https://api.openai.com/v1"
```

## Production Setup

### 1. Install Vault

<Tabs>
  <Tab title="Linux">
    ```bash
    curl -fsSL https://releases.hashicorp.com/vault/1.15.0/vault_1.15.0_linux_amd64.zip -o vault.zip
    unzip vault.zip
    sudo mv vault /usr/local/bin/
    ```
  </Tab>
  <Tab title="macOS">
    ```bash
    brew install vault
    ```
  </Tab>
  <Tab title="Kubernetes">
    ```bash
    helm repo add hashicorp https://helm.releases.hashicorp.com
    helm install vault hashicorp/vault
    ```
  </Tab>
</Tabs>

### 2. Configure Vault

```hcl
# /etc/vault.d/vault.hcl
storage "file" {
  path = "/opt/vault/data"
}

listener "tcp" {
  address     = "0.0.0.0:8200"
  tls_cert_file = "/opt/vault/tls/vault.crt"
  tls_key_file  = "/opt/vault/tls/vault.key"
}

api_addr = "https://vault.example.com:8200"
```

### 3. Initialize and Unseal

```bash
vault operator init
vault operator unseal  # Run 3 times with different keys
```

### 4. Enable KV Secrets Engine

```bash
vault secrets enable -path=secret kv-v2
```

### 5. Create Policy for CodeTether

```hcl
# codetether-policy.hcl
path "secret/data/codetether/providers/*" {
  capabilities = ["read", "list"]
}

path "secret/metadata/codetether/providers/*" {
  capabilities = ["list"]
}
```

```bash
vault policy write codetether codetether-policy.hcl
```

### 6. Create Token

```bash
vault token create -policy=codetether -ttl=24h
```

## Authentication Methods

### Static Token

The simplest method for development:

```bash
export VAULT_ADDR="https://vault.example.com:8200"
export VAULT_TOKEN="hvs.your-token"
```

### Kubernetes Auth

For Kubernetes deployments:

```bash
# Enable Kubernetes auth
vault auth enable kubernetes

# Configure it
vault write auth/kubernetes/config \
  kubernetes_host="https://kubernetes.default.svc"

# Create role for CodeTether
vault write auth/kubernetes/role/codetether-agent \
  bound_service_account_names=codetether-agent \
  bound_service_account_namespaces=default \
  policies=codetether \
  ttl=24h
```

### Vault Agent (Recommended for Production)

Use Vault Agent for automatic token renewal:

```hcl
# vault-agent.hcl
vault {
  address = "https://vault.example.com:8200"
}

auto_auth {
  method "kubernetes" {
    mount_path = "auth/kubernetes"
    config = {
      role = "codetether-agent"
    }
  }

  sink "file" {
    config = {
      path = "/tmp/vault-token"
    }
  }
}

template {
  source      = "/etc/vault/agent.tmpl"
  destination = "/tmp/vault-token"
}
```

## Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `VAULT_ADDR` | Vault server address | (required) |
| `VAULT_TOKEN` | Authentication token | (required) |
| `VAULT_MOUNT` | KV secrets engine mount | `secret` |
| `VAULT_SECRETS_PATH` | Path prefix for secrets | `codetether/providers` |

## Troubleshooting

### "HashiCorp Vault not configured"

Ensure `VAULT_ADDR` and `VAULT_TOKEN` are set:

```bash
echo $VAULT_ADDR  # Should print your Vault address
echo $VAULT_TOKEN # Should print your token (or export it)
```

### "Permission denied"

Check your Vault policy allows access to the secrets path:

```bash
vault token lookup  # Verify token is valid
vault kv list secret/codetether/providers  # Test access
```

### "No API keys available"

Verify secrets are stored correctly:

```bash
vault kv get secret/codetether/providers/openai
```

## Security Best Practices

<Steps>
  <Step title="Use Short-Lived Tokens">
    Generate tokens with limited TTL and renew them automatically.
  </Step>
  <Step title="Enable Audit Logging">
    ```bash
    vault audit enable file file_path=/var/log/vault/audit.log
    ```
  </Step>
  <Step title="Use Namespaces">
    In Vault Enterprise, use namespaces to isolate environments.
  </Step>
  <Step title="Rotate Secrets Regularly">
    Set up automated secret rotation policies.
  </Step>
</Steps>

## Next Steps

<Card title="A2A Worker Mode" icon="network-wired" href="/agent/a2a-worker">
  Connect to the CodeTether platform as a worker.
</Card>
