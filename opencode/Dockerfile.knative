FROM oven/bun:1.3.5-alpine

# Install dependencies for file operations and git
RUN apk add --no-cache \
    git \
    tar \
    gzip \
    curl \
    openssh-client \
    ca-certificates \
    jq

# Create workspace directory
RUN mkdir -p /workspace /app

WORKDIR /app

# Copy everything (simpler approach for monorepo)
# .dockerignore should exclude node_modules, .git, etc.
COPY . .

# Modify package.json to only include needed workspaces, then install
RUN jq '.workspaces.packages = ["packages/opencode", "packages/util", "packages/plugin", "packages/script", "packages/sdk/js"]' package.json > package.json.tmp && \
    mv package.json.tmp package.json && \
    bun install

# Copy entrypoint script (ensure it's executable)
RUN chmod +x /app/scripts/knative-entrypoint.sh

# Environment defaults
ENV OPENCODE_STORAGE=postgres
ENV PORT=8080
ENV WORKSPACE_DIR=/workspace
ENV SYNC_INTERVAL_SECONDS=30

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:${PORT}/.well-known/agent-card.json || exit 1

EXPOSE 8080

ENTRYPOINT ["/app/scripts/knative-entrypoint.sh"]
