{
  "project": "codetether-agent",
  "feature": "Unified Runtime Source of Truth via AgentBus",
  "branch_name": "feature/unified-runtime-source-of-truth",
  "version": "1.0",
  "user_stories": [
    {
      "id": "US-001",
      "title": "Fix handle_list_tools to use dynamic HashMap",
      "description": "Modify src/mcp/server.rs:650 to iterate self.metadata HashMap instead of returning a hardcoded Vec for tool listing",
      "acceptance_criteria": [
        "handle_list_tools() iterates self.metadata HashMap",
        "Tools registered dynamically appear in tools/list response",
        "Code compiles without errors"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [],
      "complexity": 2
    },
    {
      "id": "US-002",
      "title": "Verify dynamic tool registration works",
      "description": "Register a tool dynamically and verify tools/list returns it",
      "acceptance_criteria": [
        "Can register a new tool at runtime",
        "tools/list endpoint returns the newly registered tool",
        "Tool metadata is persisted in HashMap"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-001"
      ],
      "complexity": 2
    },
    {
      "id": "US-003",
      "title": "Enable gRPC-Web on tonic server",
      "description": "Add tonic-web 0.14, enable gRPC-Web on tonic server in src/server/mod.rs with accept_http1 and CORS",
      "acceptance_criteria": [
        "tonic-web 0.14 added to Cargo.toml",
        "gRPC-Web endpoint accepts HTTP/1.1 requests",
        "CORS configured for browser origins",
        "Server starts without errors"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [],
      "complexity": 3
    },
    {
      "id": "US-004",
      "title": "Switch buf.gen.yaml to Connect-ES generators",
      "description": "Update buf.gen.yaml to use protoc-gen-connect-es + protoc-gen-es instead of existing generators",
      "acceptance_criteria": [
        "buf.gen.yaml uses protoc-gen-connect-es",
        "buf.gen.yaml uses protoc-gen-es",
        "Proto generation completes successfully"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-003"
      ],
      "complexity": 2
    },
    {
      "id": "US-005",
      "title": "Add Connect-ES packages to marketing-site",
      "description": "Add @connectrpc/connect, @connectrpc/connect-web, @bufbuild/protobuf dependencies to marketing-site",
      "acceptance_criteria": [
        "npm install adds all three packages",
        "No package conflicts",
        "Build succeeds"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-004"
      ],
      "complexity": 2
    },
    {
      "id": "US-006",
      "title": "Generate gRPC client into marketing-site",
      "description": "Generate Connect-ES gRPC client into marketing-site/src/lib/grpc/",
      "acceptance_criteria": [
        "Client files generated in marketing-site/src/lib/grpc/",
        "All service stubs available",
        "TypeScript types generated correctly"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-005"
      ],
      "complexity": 2
    },
    {
      "id": "US-007",
      "title": "Replace dashboard REST calls with gRPC-Web",
      "description": "Replace dashboard REST calls for sendMessage, getTask, cancelTask, taskSubscription with Connect-ES gRPC-Web calls. Keep REST for codebase and worker CRUD",
      "acceptance_criteria": [
        "sendMessage uses gRPC-Web client",
        "getTask uses gRPC-Web client",
        "cancelTask uses gRPC-Web client",
        "taskSubscription uses gRPC-Web client",
        "Browser network tab shows application/grpc-web"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-006"
      ],
      "complexity": 4
    },
    {
      "id": "US-008",
      "title": "Implement POST /v1/bus/token endpoint",
      "description": "Add POST /v1/bus/token that mints 5-minute agent-scoped JWTs, OPA-authorized via policies/bus.rego",
      "acceptance_criteria": [
        "POST /v1/bus/token returns valid JWT",
        "JWT expires in 5 minutes",
        "JWT contains agent-scoped claims",
        "OPA policy validates token request"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [],
      "complexity": 3
    },
    {
      "id": "US-009",
      "title": "Implement GET /v1/bus/stream SSE endpoint",
      "description": "Add GET /v1/bus/stream SSE filtered by JWT topic claims",
      "acceptance_criteria": [
        "GET /v1/bus/stream returns SSE stream",
        "Events filtered by JWT topic claims",
        "Connection stays open for real-time updates"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-008"
      ],
      "complexity": 3
    },
    {
      "id": "US-010",
      "title": "Implement POST /v1/bus/publish endpoint",
      "description": "Add POST /v1/bus/publish validated by JWT",
      "acceptance_criteria": [
        "POST /v1/bus/publish accepts message payload",
        "JWT validation before publishing",
        "Message broadcast to subscribers"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-008"
      ],
      "complexity": 3
    },
    {
      "id": "US-011",
      "title": "Dashboard subscribes via EventSource with auto-remint",
      "description": "Dashboard subscribes via EventSource with auto-remint on expiry, replacing the current per-codebase EventSource",
      "acceptance_criteria": [
        "Dashboard connects to /v1/bus/stream",
        "Auto-remint triggers on token expiry",
        "Events display in dashboard in real-time"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-009"
      ],
      "complexity": 3
    },
    {
      "id": "US-012",
      "title": "Create Python bus_client.py SSE client",
      "description": "Python server connects via new a2a_server/bus_client.py SSE client, publishes ToolRequest and ToolResponse so Python tool calls are visible on the bus",
      "acceptance_criteria": [
        "bus_client.py connects to /v1/bus/stream",
        "Publishes ToolRequest events",
        "Publishes ToolResponse events",
        "Python tool calls visible on bus"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-010"
      ],
      "complexity": 3
    },
    {
      "id": "US-013",
      "title": "Verify cross-tab bus events work",
      "description": "Verify: trigger agent in one tab, bus events arrive in another. Kill Python, bus continues",
      "acceptance_criteria": [
        "Agent triggered in tab A fires events visible in tab B",
        "Python disconnection does not break bus",
        "Bus continues functioning without Python"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-011",
        "US-012"
      ],
      "complexity": 3
    },
    {
      "id": "US-014",
      "title": "Implement GET /v1/tools endpoint",
      "description": "Add GET /v1/tools returning merged Rust MCP plus remote registrations tagged by source",
      "acceptance_criteria": [
        "GET /v1/tools returns Rust MCP tools",
        "GET /v1/tools returns remote registrations",
        "Response includes source tag for each tool"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [],
      "complexity": 3
    },
    {
      "id": "US-015",
      "title": "Implement POST /v1/tools/register with heartbeat",
      "description": "Add POST /v1/tools/register with 30-second heartbeat, 90-second TTL, 15-second reaper",
      "acceptance_criteria": [
        "POST /v1/tools/register accepts tool registration",
        "Heartbeat resets TTL every 30 seconds",
        "Tool expires after 90 seconds without heartbeat",
        "Reaper removes expired tools every 15 seconds"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-014"
      ],
      "complexity": 4
    },
    {
      "id": "US-016",
      "title": "Python registers tools on startup and deletes on shutdown",
      "description": "Python registers on startup, DELETE on shutdown. Bus events on registration and expiry",
      "acceptance_criteria": [],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-015"
      ],
      "complexity": 3
    },
    {
      "id": "US-017",
      "title": "Create Dashboard ToolExplorer component",
      "description": "Dashboard ToolExplorer component grouped by source with name, description, params, and try-it button",
      "acceptance_criteria": [
        "ToolExplorer shows tools grouped by source",
        "Each tool shows name, description, params",
        "Try-it button functional",
        "Shows 35+ Rust tools and 4+ Python tools"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-014",
        "US-016"
      ],
      "complexity": 4
    },
    {
      "id": "US-018",
      "title": "Verify Python tools disappear after TTL",
      "description": "Verify: shows 35+ Rust tools and 4+ Python tools. Kill Python, Python tools disappear within 90 seconds",
      "acceptance_criteria": [
        "Dashboard shows 35+ Rust tools",
        "Dashboard shows 4+ Python tools when Python running",
        "Python tools disappear within 90 seconds of Python exit"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-017"
      ],
      "complexity": 3
    },
    {
      "id": "US-019",
      "title": "Relay completes all rounds with 100% success",
      "description": "Key Result KR-1: Relay completes all rounds (target: 100%)",
      "acceptance_criteria": [
        "All relay rounds complete successfully",
        "No round failures in test suite",
        "End-to-end relay test passes"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [
        "US-007",
        "US-013",
        "US-018"
      ],
      "complexity": 5
    },
    {
      "id": "US-020",
      "title": "Team produces actionable handoff",
      "description": "Key Result KR-2: Team produces actionable handoff (target: 1 count)",
      "acceptance_criteria": [
        "Documentation complete",
        "API contracts finalized",
        "Handoff notes delivered to team"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [],
      "complexity": 1
    },
    {
      "id": "US-021",
      "title": "Zero critical errors in production",
      "description": "Key Result KR-3: No critical errors (target: 0 count)",
      "acceptance_criteria": [
        "No panics in Rust code",
        "No unhandled exceptions in Python",
        "No JavaScript console errors",
        "All error paths properly handled"
      ],
      "passes": false,
      "priority": 1,
      "depends_on": [],
      "complexity": 2
    }
  ],
  "technical_requirements": [
    "Rust backend with tonic-web 0.14 for gRPC-Web support",
    "Connect-ES for TypeScript gRPC-Web client generation",
    "JWT-based authentication with 5-minute expiry",
    "OPA policy engine for bus authorization",
    "SSE for real-time event streaming",
    "EventSource API in browser for bus subscription",
    "Python SSE client for bus connection",
    "Tool registry with TTL and heartbeat mechanism",
    "CODETETHER_BUS_JWT_SECRET environment variable for signing"
  ],
  "quality_checks": {
    "typecheck": "cargo check",
    "test": "cargo test",
    "lint": "cargo clippy --all-features",
    "build": "cargo build"
  },
  "created_at": "2026-02-15T06:57:29.885638867+00:00",
  "updated_at": "2026-02-15T06:57:29.885638867+00:00"
}